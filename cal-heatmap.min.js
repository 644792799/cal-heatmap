var CalHeatMap=function(){function t(t){var e=a[i.options.subDomain].position.x(t);return e*i.options.cellsize+e*i.options.cellpadding}function e(t){var e=a[i.options.subDomain].position.y(t);return e*i.options.cellsize+e*i.options.cellpadding}function n(t){i.svg.each(function(e){d3.select(this).selectAll("rect").attr("class",function(n){var o=a[i.options.subDomain].extractUnit(n);return"graph-rect"+(t.hasOwnProperty(e)&&t[e].hasOwnProperty(o)?" "+i.scale(t[e][o]):"")}).on("click",function(n){var o=a[i.options.subDomain].extractUnit(n);return i.onClick(n,t.hasOwnProperty(e)&&t[e].hasOwnProperty(o)?t[e][o]:0)}).select("title").text(function(n){var o=a[i.options.subDomain].extractUnit(n);return(t.hasOwnProperty(e)&&t[e].hasOwnProperty(o)?s(t[e][o])+" "+i.options.itemName[t[e][o]>1?1:0]+" "+a[i.options.subDomain].format.connector+" ":"")+r(n)})})}function o(t){var e={};for(var n in t){var o=new Date(1e3*n),r=i.getDomain(o)[0];r=r.getTime();var s=a[i.options.subDomain].extractUnit(o);e[r]===void 0&&(e[r]={}),e[r][s]!==void 0?e[r][s]+=t[n]:e[r][s]=t[n]}return e}var i=this;this.options={id:"cal-heatmap",scales:[10,20,30,40],range:12,cellsize:10,cellpadding:2,format:{date:null,legend:null},onClick:function(){},displayScale:!0,itemName:["item","items"],start:new Date,uri:"",loadOnInit:!0,domain:"hour",subDomain:"min"};var r,a={min:{row:10,column:function(){return 6},position:{x:function(t){return Math.floor(t.getMinutes()/a.min.row)},y:function(t){return t.getMinutes()%a.min.row}},format:{date:"%H:%M, %A %B %-e, %Y",legend:"",connector:"at"},extractUnit:function(t){return t.getMinutes()}},hour:{row:6,column:function(t){switch(i.options.domain){case"day":return 4;case"week":return 28;case"month":return 4*i.getEndOfMonth(t).getDate()}},position:{x:function(t){return"month"===i.options.domain?Math.floor(t.getHours()/a.hour.row)+4*(t.getDate()-1):"week"===i.options.domain?Math.floor(t.getHours()/a.hour.row)+4*i.getWeekDay(t):Math.floor(t.getHours()/a.hour.row)},y:function(t){return t.getHours()%a.hour.row}},format:{date:"%Hh, %A %B %-e, %Y",legend:"%H:00",connector:"at"},extractUnit:function(t){return"hour"===i.options.subDomain?t.getHours()+""+i.getDayOfYear(t):t.getHours()}},day:{row:7,column:function(){return"year"===i.options.domain?54:5},position:{x:function(t){switch(i.options.domain){case"week":return 0;case"month":return i.getWeekNumber(t)-i.getWeekNumber(new Date(t.getFullYear(),t.getMonth()));case"year":return i.getWeekNumber(t)}},y:function(t){return 0===t.getDay()?6:t.getDay()-1}},format:{date:"%A %B %-e, %Y",legend:"%e %b",connector:"on"},extractUnit:function(t){return i.getDayOfYear(t)}},week:{row:7,column:4,position:{x:function(){return 0},y:function(){return 0}},format:{date:"",legend:""},extractUnit:function(t){return i.getWeekNumber(t)}},month:{row:1,column:function(){return 12},position:{x:function(t){return Math.floor(t.getMonth()/a.month.row)},y:function(t){return t.getMonth()%a.month.row}},format:{date:"%B %Y",legend:"%B",connector:"on"},extractUnit:function(t){return t.getMonth()}},year:{row:1,column:function(){return 12},position:{x:function(t){return Math.floor(t.getFullYear()/a.year.row)},y:function(t){return t.getFullYear()%a.year.row}},format:{date:"%Y",legend:"%Y",connector:"on"},extractUnit:function(t){return t.getFullYear()}}},s=d3.format(",d");this.svg=null;var u=null,l=function(){var s=2*i.options.cellsize;r=d3.time.format(i.options.format.date);var l=function(t){return i.options.cellsize*a[i.options.subDomain].column(t)+i.options.cellpadding*a[i.options.subDomain].column(t)},c=i.options.cellsize*a[i.options.subDomain].row+i.options.cellpadding*a[i.options.subDomain].row+i.options.cellpadding,g=d3.time.format(i.options.format.legend);return i.svg=d3.select("#"+i.options.id).append("div").attr("class","graph").selectAll().data(i.getDomain(i.options.start).map(function(t){return t.getTime()})).enter().append("div").attr("class","graph-domain").style("width",function(t){return l(t)+"px"}).style("height",c+s+"px").style("display","inline-block").append("svg:svg").attr("width",function(t){return l(t)}).attr("height",c+s).append("svg:g").attr("transform","translate(0, 1)"),i.svg.append("svg:text").attr("y",c+s/1.5).attr("class","graph-label").attr("text-anchor","middle").attr("vertical-align","middle").attr("x",function(t){return l(t)/2}).text(function(t){return g(new Date(t))}),u=i.svg.selectAll("rect").data(function(t){return i.getSubDomain(t)}).enter().append("svg:rect").attr("class","graph-rect").attr("width",i.options.cellsize).attr("height",i.options.cellsize).attr("x",function(e){return t(e)}).attr("y",function(t){return e(t)}),u.append("svg:title").text(function(t){return r(t)}),i.options.displayScale&&i.displayScale(),i.options.loadOnInit&&d3.json(i.options.uri,function(t){n(o(t))}),!0};this.init=function(t){if(null!==t&&void 0!==t&&"undefined"!==t)for(var e in i.options)null!==t[e]&&void 0!==t[e]&&"undefined"!==t[e]&&(i.options[e]=t[e]);if(!a.hasOwnProperty(i.options.domain)||"min"===i.options.domain)return console.log("The domain name is not valid"),!1;var n=i.getDomain(i.options.start);return""===i.options.uri&&(i.options.uri="/api/scheduled-jobs/stats/"+parseInt(i.options.start.getTime()/1e3,10)+"/"+parseInt(n[n.length-1].getTime()/1e3,10)),null===i.options.format.date&&(i.options.format.date=a[i.options.subDomain].format.date),null===i.options.format.legend&&(i.options.format.legend=a[i.options.domain].format.legend),l()}};CalHeatMap.prototype={onClick:function(t,e){return this.options.onClick(t,e)},displayScale:function(){var t=this;d3.select("#"+this.options.id).append("svg:svg").attr("class","graph-scale").attr("height",this.options.cellsize+2*this.options.cellpadding).selectAll().data(d3.range(0,this.options.scales.length+1)).enter().append("svg:rect").attr("width",this.options.cellsize).attr("height",this.options.cellsize).attr("class",function(t){return"graph-rect q"+(t+1)}).attr("transform",function(e){return"translate("+e*(t.options.cellsize+t.options.cellpadding)+", "+t.options.cellpadding+")"}).append("svg:title").text(function(e){return t.options.scales[e+1],0===e?"less than "+t.options.scales[e]+" "+t.options.itemName[1]:e===t.options.scales.length?"more than "+t.options.scales[e-1]+" "+t.options.itemName[1]:"between "+t.options.scales[e-1]+" and "+t.options.scales[e]+" "+t.options.itemName[1]})},getDayOfYear:d3.time.format("%j"),getWeekNumber:d3.time.format("%W"),getWeekDay:function(t){return 0===t.getDay()?6:t.getDay()-1},getEndOfMonth:function(t){return"number"==typeof t&&(t=new Date(t)),new Date(t.getFullYear(),t.getMonth()+1,0)},getWeekDomain:function(t,e){var n;return n=1===t.getDay()?new Date(t.getFullYear(),t.getMonth(),t.getDate()):new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay()+1),d3.time.mondays(n,new Date(n.getTime()+6048e5*e))},getYearDomain:function(t,e){return d3.time.years(new Date(t.getFullYear(),0),new Date(t.getFullYear()+e,0))},getMinuteDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return d3.time.minutes(n,new Date(n.getTime()+6e4*e))},getHourDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return"number"==typeof e&&(e=new Date(n.getTime()+36e5*e)),d3.time.hours(n,e)},getDayDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(n);return o=new Date(o.setDate(o.getDate()+parseInt(e,10))),d3.time.days(n,o)},getMonthDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth()),o=new Date(n);return o=o.setMonth(o.getMonth()+e),d3.time.months(n,o)},getDomain:function(t){switch("number"==typeof t&&(t=new Date(t)),this.options.domain){case"hour":return this.getHourDomain(t,this.options.range);case"day":return this.getDayDomain(t,this.options.range);case"week":return this.getWeekDomain(t,this.options.range);case"month":return this.getMonthDomain(t,this.options.range);case"year":return this.getYearDomain(t,this.options.range)}},getSubDomain:function(t){"number"==typeof t&&(t=new Date(t));var e=this,n=function(t,n){if("year"===n)return e.getDayOfYear(new Date(t.getFullYear()+1,0,0));if("month"===n){var o=new Date(t.getFullYear(),t.getMonth()+1,0);return o.getDate()}return"week"===n?7:void 0},o=function(t,e){return"day"===e?1440:"hour"===e?60:"week"===e?25200:void 0},i=function(t,e){if("day"===e)return 24;if("week"===e)return 168;if("month"===e){var n=new Date(t.getFullYear(),t.getMonth()+1,0);return 24*n.getDate()}};switch(this.options.subDomain){case"min":return this.getMinuteDomain(t,o(t,this.options.domain));case"hour":return this.getHourDomain(t,i(t,this.options.domain));case"day":return this.getDayDomain(t,n(t,this.options.domain));case"week":return this.getWeekDomain(t,1);case"month":return this.getMonthDomain(t,12)}},scale:function(t){for(var e=0,n=this.options.scales.length-1;n>e;e++){if(0===t&&this.options.scales[0]>0)return"";if(this.options.scales[0]>0&&0>t)return"qi";if(this.options.scales[e]>=t)return"q"+(e+1)}return"q"+this.options.scales.length}};