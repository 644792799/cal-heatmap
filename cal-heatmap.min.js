var CalHeatMap=function(){function t(t){var e=i[r.options.subDomain].position.x(t);return e*r.options.cellsize+e*r.options.cellpadding}function e(t){var e=i[r.options.subDomain].position.y(t);return e*r.options.cellsize+e*r.options.cellpadding}function n(t){r.svg.each(function(e){d3.select(this).selectAll("rect").attr("class",function(n){var o=i[r.options.subDomain].extractUnit(n);return"graph-rect"+(t.hasOwnProperty(e)&&t[e].hasOwnProperty(o)?" "+r.scale(t[e][o]):"")}).on("click",function(n){var o=i[r.options.subDomain].extractUnit(n);return r.onClick(n,t.hasOwnProperty(e)&&t[e].hasOwnProperty(o)?t[e][o]:0)}).select("title").text(function(n){var o=i[r.options.subDomain].extractUnit(n);return(t.hasOwnProperty(e)&&t[e].hasOwnProperty(o)?s(t[e][o])+" "+r.options.itemName[t[e][o]>1?1:0]+" "+i[r.options.subDomain].format.connector+" ":"")+a(n)})})}function o(t){var e={};for(var n in t){var o=new Date(1e3*n),a=r.getDomain(o)[0].getTime();if(!(0>r._domains.indexOf(a))){var s=i[r.options.subDomain].extractUnit(o);e[a]===void 0&&(e[a]={}),e[a][s]!==void 0?e[a][s]+=t[n]:e[a][s]=t[n]}}return e}var r=this;this.options={id:"cal-heatmap",scales:[10,20,30,40],range:12,cellsize:10,cellpadding:2,format:{date:null,legend:null},onClick:function(){},displayScale:!0,itemName:["item","items"],start:new Date,uri:"",loadOnInit:!0,domain:"hour",subDomain:"min"};var a,i={min:{row:10,column:function(){return 6},position:{x:function(t){return Math.floor(t.getMinutes()/i.min.row)},y:function(t){return t.getMinutes()%i.min.row}},format:{date:"%H:%M, %A %B %-e, %Y",legend:"",connector:"at"},extractUnit:function(t){return t.getMinutes()}},hour:{row:6,column:function(t){switch(r.options.domain){case"day":return 4;case"week":return 28;case"month":return 4*r.getEndOfMonth(t).getDate()}},position:{x:function(t){return"month"===r.options.domain?Math.floor(t.getHours()/i.hour.row)+4*(t.getDate()-1):"week"===r.options.domain?Math.floor(t.getHours()/i.hour.row)+4*r.getWeekDay(t):Math.floor(t.getHours()/i.hour.row)},y:function(t){return t.getHours()%i.hour.row}},format:{date:"%Hh, %A %B %-e, %Y",legend:"%H:00",connector:"at"},extractUnit:function(t){var e=d3.time.format("%H");return t.getFullYear()+""+r.getDayOfYear(t)+e(t)}},day:{row:7,column:function(){switch(r.options.domain){case"year":return 54;case"month":return 5;case"week":return 1}},position:{x:function(t){switch(r.options.domain){case"week":return 0;case"month":return r.getWeekNumber(t)-r.getWeekNumber(new Date(t.getFullYear(),t.getMonth()));case"year":return r.getWeekNumber(t)}},y:function(t){return 0===t.getDay()?6:t.getDay()-1}},format:{date:"%A %B %-e, %Y",legend:"%e %b",connector:"on"},extractUnit:function(t){return t.getFullYear()+""+r.getDayOfYear(t)}},week:{row:1,column:function(t){switch(t=new Date(t),r.options.domain){case"year":return 54;case"month":return r.getWeekNumber(new Date(t.getFullYear(),t.getMonth()+1,0))-r.getWeekNumber(t)}return 1},position:{x:function(t){switch(r.options.domain){case"year":return r.getWeekNumber(t);case"month":return r.getWeekNumber(t)-r.getWeekNumber(new Date(t.getFullYear(),t.getMonth()))-1}},y:function(){return 0}},format:{date:"%B Week #%W",legend:"%B Week #%W",connector:"on"},extractUnit:function(t){return r.getWeekNumber(t)}},month:{row:1,column:function(){return 12},position:{x:function(t){return Math.floor(t.getMonth()/i.month.row)},y:function(t){return t.getMonth()%i.month.row}},format:{date:"%B %Y",legend:"%B",connector:"on"},extractUnit:function(t){return t.getMonth()}},year:{row:1,column:function(){return 12},position:{x:function(t){return Math.floor(t.getFullYear()/i.year.row)},y:function(t){return t.getFullYear()%i.year.row}},format:{date:"%Y",legend:"%Y",connector:"on"},extractUnit:function(t){return t.getFullYear()}}},s=d3.format(",d");this.svg=null;var u=null;this._domains=[];var l=function(){var n=2*r.options.cellsize;a=d3.time.format(r.options.format.date);var o=function(t){return r.options.cellsize*i[r.options.subDomain].column(t)+r.options.cellpadding*i[r.options.subDomain].column(t)},s=r.options.cellsize*i[r.options.subDomain].row+r.options.cellpadding*i[r.options.subDomain].row+r.options.cellpadding,l=d3.time.format(r.options.format.legend);return r._domains=r.getDomain(r.options.start).map(function(t){return t.getTime()}),r.svg=d3.select("#"+r.options.id).append("div").attr("class","graph").selectAll().data(r._domains).enter().append("div").attr("class","graph-domain").style("width",function(t){return o(t)+"px"}).style("height",s+n+"px").style("display","inline-block").append("svg:svg").attr("width",function(t){return o(t)}).attr("height",s+n).append("svg:g").attr("transform","translate(0, 1)"),r.svg.append("svg:text").attr("y",s+n/1.5).attr("class","graph-label").attr("text-anchor","middle").attr("vertical-align","middle").attr("x",function(t){return o(t)/2}).text(function(t){return l(new Date(t))}),u=r.svg.selectAll("rect").data(function(t){return r.getSubDomain(t)}).enter().append("svg:rect").attr("class","graph-rect").attr("width",r.options.cellsize).attr("height",r.options.cellsize).attr("x",function(e){return t(e)}).attr("y",function(t){return e(t)}),u.append("svg:title").text(function(t){return a(t)}),r.options.displayScale&&r.displayScale(),r.options.loadOnInit&&r.fill(r.options.uri),!0};this.fill=function(t){d3.json(t,function(t){n(o(t))})},this.init=function(t){if(null!==t&&void 0!==t&&"undefined"!==t)for(var e in r.options)null!==t[e]&&void 0!==t[e]&&"undefined"!==t[e]&&(r.options[e]=t[e]);if(!i.hasOwnProperty(r.options.domain)||"min"===r.options.domain)return console.log("The domain name is not valid"),!1;var n=r.getDomain(r.options.start);return""===r.options.uri&&(r.options.uri="/api/scheduled-jobs/stats/"+parseInt(r.options.start.getTime()/1e3,10)+"/"+parseInt(n[n.length-1].getTime()/1e3,10)),null===r.options.format.date&&(r.options.format.date=i[r.options.subDomain].format.date),null===r.options.format.legend&&(r.options.format.legend=i[r.options.domain].format.legend),l()}};CalHeatMap.prototype={onClick:function(t,e){return this.options.onClick(t,e)},displayScale:function(){var t=this;d3.select("#"+this.options.id).append("svg:svg").attr("class","graph-scale").attr("height",this.options.cellsize+2*this.options.cellpadding).selectAll().data(d3.range(0,this.options.scales.length+1)).enter().append("svg:rect").attr("width",this.options.cellsize).attr("height",this.options.cellsize).attr("class",function(t){return"graph-rect q"+(t+1)}).attr("transform",function(e){return"translate("+e*(t.options.cellsize+t.options.cellpadding)+", "+t.options.cellpadding+")"}).append("svg:title").text(function(e){return t.options.scales[e+1],0===e?"less than "+t.options.scales[e]+" "+t.options.itemName[1]:e===t.options.scales.length?"more than "+t.options.scales[e-1]+" "+t.options.itemName[1]:"between "+t.options.scales[e-1]+" and "+t.options.scales[e]+" "+t.options.itemName[1]})},getDayOfYear:d3.time.format("%j"),getWeekNumber:d3.time.format("%W"),getWeekDay:function(t){return 0===t.getDay()?6:t.getDay()-1},getEndOfMonth:function(t){return"number"==typeof t&&(t=new Date(t)),new Date(t.getFullYear(),t.getMonth()+1,0)},getWeekDomain:function(t,e){var n;1===t.getDay()?n=new Date(t.getFullYear(),t.getMonth(),t.getDate()):0===t.getDay()?(n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n.setDate(n.getDate()-6)):n=new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay()+1);var o=new Date(n);return d3.time.mondays(n,new Date(o.setDate(o.getDate()+7*e)))},getYearDomain:function(t,e){return d3.time.years(new Date(t.getFullYear(),0),new Date(t.getFullYear()+e,0))},getMinuteDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return d3.time.minutes(n,new Date(n.getTime()+6e4*e))},getHourDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return"number"==typeof e&&(e=new Date(n.getTime()+36e5*e)),d3.time.hours(n,e)},getDayDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(n);return o=new Date(o.setDate(o.getDate()+parseInt(e,10))),d3.time.days(n,o)},getMonthDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth()),o=new Date(n);return o=o.setMonth(o.getMonth()+e),d3.time.months(n,o)},getDomain:function(t){switch("number"==typeof t&&(t=new Date(t)),this.options.domain){case"hour":return this.getHourDomain(t,this.options.range);case"day":return this.getDayDomain(t,this.options.range);case"week":return this.getWeekDomain(t,this.options.range);case"month":return this.getMonthDomain(t,this.options.range);case"year":return this.getYearDomain(t,this.options.range)}},getSubDomain:function(t){"number"==typeof t&&(t=new Date(t));var e=this,n=function(t,n){if("year"===n)return e.getDayOfYear(new Date(t.getFullYear()+1,0,0));if("month"===n){var o=new Date(t.getFullYear(),t.getMonth()+1,0);return o.getDate()}return"week"===n?7:void 0},o=function(t,e){return"day"===e?1440:"hour"===e?60:"week"===e?25200:void 0},r=function(t,e){if("day"===e)return 24;if("week"===e)return 168;if("month"===e){var n=new Date(t.getFullYear(),t.getMonth()+1,0);return 24*n.getDate()}},a=function(t,n){if("month"===n){var o=new Date(t.getFullYear(),t.getMonth()+1,0),r=e.getWeekNumber(o),a=e.getWeekNumber(new Date(t.getFullYear(),t.getMonth()));return a>r&&(a=0,r++),r-a+1}return"year"===n?e.getDayOfYear(new Date(t.getFullYear(),11,31)):void 0};switch(this.options.subDomain){case"min":return this.getMinuteDomain(t,o(t,this.options.domain));case"hour":return this.getHourDomain(t,r(t,this.options.domain));case"day":return this.getDayDomain(t,n(t,this.options.domain));case"week":return this.getWeekDomain(t,a(t,this.options.domain));case"month":return this.getMonthDomain(t,12)}},scale:function(t){for(var e=0,n=this.options.scales.length-1;n>e;e++){if(0===t&&this.options.scales[0]>0)return"";if(this.options.scales[0]>0&&0>t)return"qi";if(this.options.scales[e]>=t)return"q"+(e+1)}return"q"+this.options.scales.length}};